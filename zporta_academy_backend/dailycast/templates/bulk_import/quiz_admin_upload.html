{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<div class="container" style="max-width: 1100px;">
  <h1>Quiz Import (JSON)</h1>

  {% if errors %}
    <div class="messagelist">
      {% for e in errors %}<div class="error">‚ö†Ô∏è {{ e }}</div>{% endfor %}
    </div>
  {% endif %}

  {% if warnings %}
    <div class="messagelist">
      {% for w in warnings %}<div class="warning">{{ w }}</div>{% endfor %}
    </div>
  {% endif %}

  {% if not preview %}
    <form method="post" enctype="multipart/form-data" class="module">
      {% csrf_token %}
      <fieldset class="module aligned">
        <div class="form-row">
          <label>JSON file:</label>
          <input type="file" name="json_file" accept=".json,application/json" required />
        </div>
        <p class="help">Format: { "quizzes": [ { "title": "...", "subject_name": "...", "questions": [ ... ] } ] }</p>
      </fieldset>
      <div class="submit-row">
        <input type="submit" value="Preview" class="default" />
      </div>
    </form>
  {% else %}
    <div class="module" style="padding: 12px; margin-bottom: 16px;">
      <strong>Found:</strong> {{ preview.counts.quizzes }} quiz(es), {{ preview.counts.questions }} question(s)
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="confirm" value="yes" />
      <textarea name="json_payload" hidden>{{ json_payload }}</textarea>

      {% for quiz in preview.quizzes %}
        <div class="module" style="margin-bottom: 18px;">
          <h3 style="margin-top:0;">üìù Quiz {{ forloop.counter }}: {{ quiz.title }}</h3>
          <p style="color:#555;">Subject: {{ quiz.subject_name|default:"(none)" }} | Difficulty: {{ quiz.difficulty_level|default:"medium" }} | Status: {{ quiz.status|default:"published" }}</p>
          <p style="color:#777;">SEO title (auto if blank): {{ quiz.seo_title|default:"(auto from title)" }}<br />SEO description (auto if blank): {{ quiz.seo_description|default:"(auto from content/title)" }}</p>
          <p style="color:#777;">Tags: {% if quiz.tag_names %}{{ quiz.tag_names|join:", " }}{% else %}(none){% endif %}</p>

          {% if quiz.questions %}
            <ol>
              {% for q in quiz.questions %}
                <li style="margin-bottom:14px;">
                  <div style="font-weight:bold;">Q{{ forloop.counter }} ({{ q.question_type|default:"mcq" }}): {{ q.question_text }}</div>
                  {% if q.question_type == "mcq" or q.question_type == "multi" %}
                    <div style="color:#555; margin-top:4px;">
                      {% if q.option1 %}<div>A) {{ q.option1 }}</div>{% endif %}
                      {% if q.option2 %}<div>B) {{ q.option2 }}</div>{% endif %}
                      {% if q.option3 %}<div>C) {{ q.option3 }}</div>{% endif %}
                      {% if q.option4 %}<div>D) {{ q.option4 }}</div>{% endif %}
                      {% if q.correct_option %}<div style="color:#2b7a0b;">‚úì Correct: Option {{ q.correct_option }}</div>{% endif %}
                    </div>
                  {% endif %}
                  {% if q.question_type == "short" %}
                    <div style="color:#555; margin-top:4px;">Answer: {{ q.correct_answer }}</div>
                  {% endif %}
                  <div style="margin-top:6px; display:flex; gap:12px; flex-wrap:wrap;">
                    <div>
                      <label>Question image (optional)</label><br/>
                      <input type="file" name="q{{ forloop.parentloop.counter0 }}_img_{{ forloop.counter0 }}" accept="image/*" />
                    </div>
                    <div>
                      <label>Question audio (optional)</label><br/>
                      <input type="file" name="q{{ forloop.parentloop.counter0 }}_aud_{{ forloop.counter0 }}" accept="audio/*" />
                    </div>
                  </div>
                  {% if q.hint1 %}<div style="color:#777; margin-top:4px;">Hint: {{ q.hint1 }}</div>{% endif %}
                </li>
              {% endfor %}
            </ol>
          {% else %}
            <div style="color:#999;">No questions.</div>
          {% endif %}
        </div>
      {% endfor %}

      <div class="submit-row">
        <a href="" class="button" style="margin-right:8px;">Start over</a>
        <input type="submit" value="Confirm & Create" class="default" />
      </div>
    </form>
  {% endif %}
</div>
{% endblock %}
