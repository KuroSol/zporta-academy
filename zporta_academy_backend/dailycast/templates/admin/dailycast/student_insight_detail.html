{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .insight-container {
            margin: 20px;
            max-width: 1200px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #417690;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .student-header {
            background: linear-gradient(135deg, #417690 0%, #2e5568 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .student-header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        .student-header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        .section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #417690;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #417690;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #417690;
            display: block;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }
        .refresh-controls {
            background: #f8f9fa;
            border: 2px solid #417690;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .refresh-controls h3 {
            margin: 0 0 15px 0;
            color: #417690;
            font-size: 18px;
        }
        .refresh-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .refresh-form label {
            font-weight: bold;
            color: #333;
        }
        .refresh-form select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        .refresh-btn {
            background: #417690;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .refresh-btn:hover {
            background: #2e5568;
        }
        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading-indicator {
            display: none;
            color: #417690;
            font-weight: bold;
            margin-left: 15px;
        }
        .loading-indicator.active {
            display: inline-block;
        }
        .courses-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .course-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
        }
        .course-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .course-meta {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }
        .weak-topics, .strong-topics {
            list-style: none;
            padding: 0;
        }
        .weak-topics li {
            background: #fff3e0;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strong-topics li {
            background: #e8f5e9;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topic-name {
            font-weight: 500;
            color: #333;
        }
        .topic-score {
            font-weight: bold;
            font-size: 18px;
        }
        .weak-topics .topic-score {
            color: #f57c00;
        }
        .strong-topics .topic-score {
            color: #2e7d32;
        }
        .recommendations-list {
            list-style: none;
            padding: 0;
        }
        .recommendations-list li {
            background: #f3e5f5;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #9c27b0;
            position: relative;
            padding-left: 45px;
        }
        .recommendations-list li:before {
            content: "üéØ";
            position: absolute;
            left: 15px;
            font-size: 20px;
        }
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error-message {
            background: #ffebee;
            border: 1px solid #ef5350;
            border-radius: 6px;
            padding: 20px;
            color: #c62828;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .badge-warning {
            background: #fff3e0;
            color: #f57c00;
        }
        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .badge-info {
            background: #e3f2fd;
            color: #1976d2;
        }
    </style>
{% endblock %}

{% block content %}
<div class="insight-container">
    <a href="{% url 'admin:dailycast_studentlearninginsight_changelist' %}" class="back-link">
        ‚Üê Back to All Students
    </a>

    <div class="student-header">
        <h1>{{ user.get_full_name|default:user.username }}</h1>
        <div class="subtitle">
            @{{ user.username }} ‚Ä¢ Member since {{ user.date_joined|date:"F d, Y" }}
        </div>
    </div>

    <!-- SUMMARY SECTION (Always Visible) -->
    <div class="section">
        <h2 class="section-title">üìä Learning Summary</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value">{{ analysis.total_courses|default:0 }}</span>
                <span class="stat-label">üìö Enrolled Courses</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.lessons_completed|default:0 }}</span>
                <span class="stat-label">‚úÖ Lessons Completed</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.notes_count|default:0 }}</span>
                <span class="stat-label">üìî Notes Written</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.quizzes_completed|default:0 }}</span>
                <span class="stat-label">üìù Quizzes Taken</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.quiz_accuracy|default:0|floatformat:1 }}%</span>
                <span class="stat-label">üéØ Quiz Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.study_streak|default:0 }}</span>
                <span class="stat-label">üî• Study Streak (days)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.active_days|default:0 }}</span>
                <span class="stat-label">üìÖ Active Days (30d)</span>
            </div>
        </div>
    </div>

    <!-- AI INSIGHTS PANEL -->
    <div class="section">
        <h2 class="section-title">ü§ñ AI-Generated Insights</h2>
        
        <!-- USER PREFERENCES OVERVIEW -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <!-- INTERESTED SUBJECTS -->
            <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 15px; border-radius: 4px;">
                <strong style="color: #6a1b9a; display: block; margin-bottom: 10px;">üìö Interested Subjects:</strong>
                {% if interested_subjects_list %}
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for subject in interested_subjects_list %}
                        <span style="background: #9c27b0; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                            {{ subject.name }}
                            {% if forloop.first %}<span style="margin-left: 5px;">‚òÖ Primary</span>{% endif %}
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span style="color: #999; font-size: 13px;">No subjects selected</span>
                {% endif %}
            </div>
            
            <!-- INTERESTED TAGS -->
            <div style="background: #e0f2f1; border-left: 4px solid #00897b; padding: 15px; border-radius: 4px;">
                <strong style="color: #004d40; display: block; margin-bottom: 10px;">üè∑Ô∏è Learning Interests:</strong>
                {% if interested_tags_list %}
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for tag in interested_tags_list %}
                        <span style="background: #00897b; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px;">
                            {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span style="color: #999; font-size: 13px;">No tags selected</span>
                {% endif %}
            </div>
            
            <!-- RECENT ACTIVITY SUMMARY -->
            <div style="background: #fff3e0; border-left: 4px solid #ff6f00; padding: 15px; border-radius: 4px;">
                <strong style="color: #e65100; display: block; margin-bottom: 10px;">üìä Recent Activity:</strong>
                {% if user_activity_data %}
                    <div style="font-size: 13px;">
                        <div style="color: #666;">Last 10 activities:</div>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #555;">
                            {% for activity in user_activity_data|slice:":3" %}
                            <li style="margin-bottom: 4px;">
                                <strong>{{ activity.activity_type }}</strong>
                                <div style="font-size: 12px; color: #888;">{{ activity.created_at|date:"M d, Y H:i" }}</div>
                            </li>
                            {% endfor %}
                            {% if user_activity_data|length > 3 %}
                            <li style="color: #999;">+ {{ user_activity_data|length|add:"-3" }} more activities</li>
                            {% endif %}
                        </ul>
                    </div>
                {% else %}
                    <span style="color: #999; font-size: 13px;">No recent activity</span>
                {% endif %}
            </div>
        </div>
        
        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label for="ai-subject" style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">Focus Subject:</label>
                    <select id="ai-subject" name="ai_subject" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        <option value="">üìö All Subjects</option>
                        {% for subject_id, subject_name in enrolled_subjects %}
                        <option value="{{ subject_name }}" {% if subject_name == primary_subject %}selected{% endif %}>{{ subject_name }}</option>
                        {% endfor %}
                        {% if not enrolled_subjects %}
                        <option disabled style="color: #999;">No enrolled subjects</option>
                        {% endif %}
                    </select>
                </div>
                <div>
                    <label for="ai-engine" style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">AI Engine:</label>
                    <select id="ai-engine" name="ai_engine" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        <optgroup label="Google Gemini">
                            <option value="gemini-2.0-flash-exp" selected>‚ö° Gemini 2.0 Flash (Fast)</option>
                            <option value="gemini-2.0-pro-exp">‚ú® Gemini 2.0 Pro (Best)</option>
                            <option value="gemini-1.5-pro">üîß Gemini 1.5 Pro</option>
                        </optgroup>
                        <optgroup label="OpenAI">
                            <option value="gpt-4o-mini">‚ö° GPT-4o Mini (Fast)</option>
                            <option value="gpt-4o">üéØ GPT-4o (Balanced)</option>
                            <option value="gpt-4-turbo">üöÄ GPT-4 Turbo (Best)</option>
                        </optgroup>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" class="refresh-btn" id="generate-insights-btn" onclick="generateAIInsights()" style="width: 100%; margin: 0;">
                        ‚ú® Generate Insights
                    </button>
                </div>
            </div>
            <span class="loading-indicator" id="insights-loading" style="display: none; text-align: center; width: 100%; margin-bottom: 10px;">
                ‚è≥ Analyzing student data with AI...
            </span>
            <div id="insights-result" style="display: none; background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #2196f3;"></div>
            <div id="insights-error" style="display: none; background: #ffebee; padding: 15px; border-radius: 6px; border-left: 4px solid #f44336; color: #c62828;"></div>
        </div>
    </div>

    <!-- COURSES & LESSONS SECTION -->
    {% if analysis.enrolled_courses %}
    <div class="section">
        <h2 class="section-title">üìö Enrolled Courses & Lessons</h2>
        <ul class="courses-list">
            {% for course in analysis.enrolled_courses %}
            <li class="course-item">
                <div class="course-title">{{ course.title }}</div>
                <div class="course-meta">
                    üìñ {{ course.subject|default:"Unknown Subject" }}
                    {% if course.enrollment_date %}
                    ‚Ä¢ Enrolled: {{ course.enrollment_date|date:"M d, Y" }}
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- AREAS FOR IMPROVEMENT SECTION -->
    {% if analysis.weak_topics %}
    <div class="section">
        <h2 class="section-title">‚ö†Ô∏è Areas for Improvement</h2>
        <p style="color: #666; margin-bottom: 15px;">
            Topics with scores below 70% need more practice. Focus here for biggest gains!
        </p>
        <ul class="weak-topics">
            {% for topic in analysis.weak_topics %}
            <li>
                <span class="topic-name">{{ topic.topic }}</span>
                <span class="topic-score">{{ topic.avg_score }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- STRONG AREAS SECTION -->
    {% if analysis.strong_topics %}
    <div class="section">
        <h2 class="section-title">üí™ Strong Areas</h2>
        <p style="color: #666; margin-bottom: 15px;">
            Excellent mastery! Scoring 85%+ shows strong understanding of these topics.
        </p>
        <ul class="strong-topics">
            {% for topic in analysis.strong_topics %}
            <li>
                <span class="topic-name">{{ topic.topic }}</span>
                <span class="topic-score">{{ topic.avg_score }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- RECOMMENDATIONS SECTION -->
    <div class="section">
        <h2 class="section-title">üéØ Recommendations</h2>
        
        {% if recommendations.priority_actions %}
        <h3 style="color: #666; font-size: 16px; margin: 0 0 15px 0;">üìå Priority Actions</h3>
        <ul class="recommendations-list">
            {% for action in recommendations.priority_actions %}
            <li>{{ action }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if recommendations.study_tips %}
        <h3 style="color: #666; font-size: 16px; margin: 20px 0 15px 0;">üí° Study Tips</h3>
        <ul class="recommendations-list">
            {% for tip in recommendations.study_tips %}
            <li>
                <strong>{{ tip.type|title }}:</strong> {{ tip.message }}<br>
                <em style="color: #666; font-size: 13px;">üí° {{ tip.suggestion }}</em>
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if recommendations.next_steps %}
        <h3 style="color: #666; font-size: 16px; margin: 20px 0 15px 0;">üìã Next Steps</h3>
        <ul class="recommendations-list">
            {% for step in recommendations.next_steps %}
            <li>{{ step }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if not recommendations.priority_actions and not recommendations.study_tips and not recommendations.next_steps %}
        <div class="no-data-message">
            <p>üéâ Great start! Complete more activities to get personalized recommendations.</p>
        </div>
        {% endif %}
    </div>

    <!-- RECENT ACTIVITY SECTION -->
    {% if analysis.recent_activity %}
    <div class="section">
        <h2 class="section-title">üìà Recent Activity</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value">{{ analysis.recent_activity.last_7_days.total_events|default:0 }}</span>
                <span class="stat-label">Events (Last 7 Days)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.recent_activity.last_30_days.total_events|default:0 }}</span>
                <span class="stat-label">Events (Last 30 Days)</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Helper function to format nested objects/arrays
function formatNestedObject(obj) {
    if (!obj) return '';
    let html = '';
    if (Array.isArray(obj)) {
        html += '<ul>';
        obj.forEach(item => {
            if (typeof item === 'object') {
                html += '<li>' + formatNestedObject(item) + '</li>';
            } else {
                html += '<li>' + item + '</li>';
            }
        });
        html += '</ul>';
    } else if (typeof obj === 'object') {
        html += '<ul>';
        for (let key in obj) {
            if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                if (Array.isArray(value)) {
                    html += '<li><strong>' + label + ':</strong><ul>';
                    value.forEach(v => {
                        if (typeof v === 'object') {
                            html += '<li>' + formatNestedObject(v) + '</li>';
                        } else {
                            html += '<li>' + v + '</li>';
                        }
                    });
                    html += '</ul></li>';
                } else if (typeof value === 'object') {
                    html += '<li><strong>' + label + ':</strong> ' + formatNestedObject(value) + '</li>';
                } else {
                    html += '<li><strong>' + label + ':</strong> ' + value + '</li>';
                }
            }
        }
        html += '</ul>';
    } else {
        html += '<p>' + obj + '</p>';
    }
    return html;
}

function generateAIInsights() {
    console.log('üîò Generate button clicked');
    const btn = document.getElementById('generate-insights-btn');
    const loading = document.getElementById('insights-loading');
    const result = document.getElementById('insights-result');
    const errorDiv = document.getElementById('insights-error');
    const subject = document.getElementById('ai-subject').value;
    const engine = document.getElementById('ai-engine').value;
    
    console.log('üìä Selected subject:', subject);
    console.log('ü§ñ Selected engine:', engine);
    
    // Clear previous results
    result.style.display = 'none';
    errorDiv.style.display = 'none';
    
    // Disable button and show loading
    btn.disabled = true;
    loading.style.display = 'block';
    btn.textContent = '‚è≥ Generating...';
    
    console.log('üöÄ Sending request to:', '{% url "admin:student_ai_insights" user.id %}');
    
    // Make AJAX request to AI insights endpoint
    fetch('{% url "admin:student_ai_insights" user.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            subject: subject,
            engine: engine
        })
    })
    .then(response => {
        console.log('üì° Response received:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üì¶ Data received:', data);
        loading.style.display = 'none';
        btn.disabled = false;
        btn.textContent = '‚ú® Generate Insights';
        
        if (data.success) {
            const insights = data.insights;
            let html = '<h3 style="color: #1976d2; margin-top: 0;">üìä Comprehensive Learning Analysis</h3>';
            
            // EXECUTIVE SUMMARY
            if (insights.summary) {
                html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2196f3;">';
                html += '<p style="margin: 0; color: #1565c0;"><strong>Executive Summary:</strong></p>';
                html += '<p style="margin: 5px 0 0 0; color: #333;">' + insights.summary + '</p>';
                html += '</div>';
            }
            
            // ASSESSMENT
            if (insights.assessment) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #333; margin: 0 0 10px 0;">üìç Current Learning Level</h4>';
                if (typeof insights.assessment === 'object') {
                    html += formatNestedObject(insights.assessment);
                } else {
                    html += '<p>' + insights.assessment + '</p>';
                }
                html += '</div>';
            }
            
            // VOCABULARY GAPS
            if (insights.vocabulary_gaps) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #d32f2f; margin: 0 0 10px 0;">üìö Vocabulary Gaps</h4>';
                if (typeof insights.vocabulary_gaps === 'object') {
                    html += formatNestedObject(insights.vocabulary_gaps);
                } else {
                    html += '<p>' + insights.vocabulary_gaps + '</p>';
                }
                html += '</div>';
            }
            
            // GRAMMAR ANALYSIS
            if (insights.grammar_analysis) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #7b1fa2; margin: 0 0 10px 0;">‚úçÔ∏è Grammar Analysis</h4>';
                if (typeof insights.grammar_analysis === 'object') {
                    html += formatNestedObject(insights.grammar_analysis);
                } else {
                    html += '<p>' + insights.grammar_analysis + '</p>';
                }
                html += '</div>';
            }
            
            // QUIZ RECOMMENDATIONS
            if (insights.quiz_recommendations && insights.quiz_recommendations.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #0277bd; margin: 0 0 10px 0;">üéØ Recommended Quizzes</h4><ul>';
                insights.quiz_recommendations.forEach(q => {
                    html += '<li style="margin-bottom: 8px;"><strong>' + (q.title || q.topic || q) + '</strong>';
                    if (q.reason) html += '<br><span style="color: #666; font-size: 13px;">' + q.reason + '</span>';
                    if (q.difficulty) html += '<br><span style="background: #fff3e0; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Difficulty: ' + q.difficulty + '</span>';
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            
            // DIFFICULTY PROGRESSION
            if (insights.difficulty_progression) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #00796b; margin: 0 0 10px 0;">üìà Difficulty Progression</h4>';
                if (typeof insights.difficulty_progression === 'object') {
                    html += formatNestedObject(insights.difficulty_progression);
                } else {
                    html += '<p>' + insights.difficulty_progression + '</p>';
                }
                html += '</div>';
            }
            
            // EXTERNAL RESOURCES
            if (insights.external_resources) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #c62828; margin: 0 0 10px 0;">üåê External Resources</h4>';
                if (typeof insights.external_resources === 'object') {
                    html += formatNestedObject(insights.external_resources);
                } else {
                    html += '<p>' + insights.external_resources + '</p>';
                }
                html += '</div>';
            }
            
            // STUDY GUIDE
            if (insights.study_guide) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #f57f17; margin: 0 0 10px 0;">üìã Study Guide</h4>';
                if (typeof insights.study_guide === 'object') {
                    html += formatNestedObject(insights.study_guide);
                } else {
                    html += '<p>' + insights.study_guide + '</p>';
                }
                html += '</div>';
            }
            
            // LEARNING JOURNEY
            if (insights.learning_journey) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #00838f; margin: 0 0 10px 0;">üöÄ Learning Journey</h4>';
                if (typeof insights.learning_journey === 'object') {
                    html += formatNestedObject(insights.learning_journey);
                } else {
                    html += '<p>' + insights.learning_journey + '</p>';
                }
                html += '</div>';
            }
            
            // SPECIFIC ACTIONS
            if (insights.specific_actions) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #388e3c; margin: 0 0 10px 0;">‚úÖ Specific Actions</h4>';
                if (typeof insights.specific_actions === 'object') {
                    html += formatNestedObject(insights.specific_actions);
                } else {
                    html += '<p>' + insights.specific_actions + '</p>';
                }
                html += '</div>';
            }
            
            // POTENTIAL STRUGGLES
            if (insights.potential_struggles) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #e64a19; margin: 0 0 10px 0;">‚ö†Ô∏è Potential Struggles</h4>';
                if (Array.isArray(insights.potential_struggles)) {
                    html += '<ul>';
                    insights.potential_struggles.forEach(s => {
                        html += '<li>' + s + '</li>';
                    });
                    html += '</ul>';
                } else if (typeof insights.potential_struggles === 'object') {
                    html += formatNestedObject(insights.potential_struggles);
                } else {
                    html += '<p>' + insights.potential_struggles + '</p>';
                }
                html += '</div>';
            }
            
            result.innerHTML = html;
            result.style.display = 'block';
        } else {
            console.error('‚ùå Error in response:', data.error);
            errorDiv.innerHTML = '<strong>‚ö†Ô∏è Error:</strong> ' + (data.error || 'Failed to generate insights');
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('‚ùå Fetch error:', error);
        loading.style.display = 'none';
        errorDiv.innerHTML = '<strong>‚ö†Ô∏è Network Error:</strong> ' + error.message;
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = '‚ú® Generate Insights';
    });
}
</script>
{% endblock %}
