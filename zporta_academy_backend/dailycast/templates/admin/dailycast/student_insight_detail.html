{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .insight-container {
            margin: 20px;
            max-width: 1200px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #417690;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .student-header {
            background: linear-gradient(135deg, #417690 0%, #2e5568 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .student-header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        .student-header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        .section {
            background: #1a1a2e;
            border: 1px solid #2d2d44;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            color: #e0e0e0;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #417690;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #252540;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #417690;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #6ab7ff;
            display: block;
        }
        .stat-label {
            font-size: 13px;
            color: #b0b0b0;
            margin-top: 8px;
        }
        .refresh-controls {
            background: #252540;
            border: 2px solid #417690;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .refresh-controls h3 {
            margin: 0 0 15px 0;
            color: #6ab7ff;
            font-size: 18px;
        }
        .refresh-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .refresh-form label {
            font-weight: bold;
            color: #e0e0e0;
        }
        .refresh-form select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        .refresh-btn {
            background: #417690;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .refresh-btn:hover {
            background: #2e5568;
        }
        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* Select dropdown styling */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%236ab7ff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 35px !important;
            /* Ensure selected text is visible */
            color: #ffffff !important;
            line-height: normal;
            text-rendering: auto;
            letter-spacing: normal;
            word-spacing: normal;
            text-transform: none;
            text-indent: 0px;
            text-shadow: none;
            display: inline-block;
        }
        select option {
            background: #252540;
            color: #ffffff;
            padding: 10px;
        }
        select optgroup {
            background: #1a1a2e;
            color: #6ab7ff;
            font-weight: bold;
        }
        .loading-indicator {
            display: none;
            color: #417690;
            font-weight: bold;
            margin-left: 15px;
        }
        .loading-indicator.active {
            display: inline-block;
        }
        .courses-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .course-item {
            border: 1px solid #4caf50;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
        }
        .course-title {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 16px;
        }
        .course-meta {
            color: #b0b0b0;
            font-size: 13px;
            margin-top: 5px;
        }
        .weak-topics, .strong-topics {
            list-style: none;
            padding: 0;
        }
        .weak-topics li {
            border: 1px solid #ff9800;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strong-topics li {
            border: 1px solid #4caf50;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topic-name {
            font-weight: 500;
            color: #ffffff;
        }
        .topic-score {
            font-weight: bold;
            font-size: 18px;
        }
        .weak-topics .topic-score {
            color: #ffb74d;
        }
        .strong-topics .topic-score {
            color: #66bb6a;
        }
        .recommendations-list {
            list-style: none;
            padding: 0;
        }
        .recommendations-list li {
            border: 1px solid #9c27b0;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #9c27b0;
            position: relative;
            padding-left: 45px;
        }
        .recommendations-list li:before {
            content: "üéØ";
            position: absolute;
            left: 15px;
            font-size: 20px;
        }
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error-message {
            border: 1px solid #ef5350;
            border-radius: 6px;
            padding: 20px;
            color: #ff8a80;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .badge-warning {
            border: 1px solid #ffb74d;
            color: #ffb74d;
        }
        .badge-success {
            border: 1px solid #66bb6a;
            color: #66bb6a;
        }
        .badge-info {
            border: 1px solid #64b5f6;
            color: #64b5f6;
        }
        
        /* Accordion styles for old insights */
        .old-insights-section {
            margin-bottom: 25px;
        }
        .accordion-item {
            background: #252540;
            border: 1px solid #2d2d44;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .accordion-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d44;
            border-bottom: 1px solid #3a3a5a;
            transition: background 0.3s;
        }
        .accordion-header:hover {
            background: #3a3a5a;
        }
        .accordion-title {
            font-size: 16px;
            font-weight: bold;
            color: #6ab7ff;
            margin: 0;
        }
        .accordion-meta {
            font-size: 13px;
            color: #b0b0b0;
            margin-top: 4px;
        }
        .accordion-icon {
            font-size: 20px;
            transition: transform 0.3s;
            color: #6ab7ff;
        }
        .accordion-icon.expanded {
            transform: rotate(180deg);
        }
        .accordion-content {
            display: none;
            padding: 20px;
            background: #1a1a2e;
        }
        .accordion-content.show {
            display: block;
        }
    </style>
{% endblock %}

{% block content %}
<div class="insight-container">
    <a href="{% url 'admin:dailycast_studentlearninginsight_changelist' %}" class="back-link">
        ‚Üê Back to All Students
    </a>

    <div class="student-header">
        <h1>{{ user.get_full_name|default:user.username }}</h1>
        <div class="subtitle">
            @{{ user.username }} ‚Ä¢ Member since {{ user.date_joined|date:"F d, Y" }}
        </div>
    </div>

    <!-- SUMMARY SECTION (Always Visible) -->
    <div class="section">
        <h2 class="section-title">üìä Learning Summary</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value">{{ analysis.total_courses|default:0 }}</span>
                <span class="stat-label">üìö Enrolled Courses</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.lessons_completed|default:0 }}</span>
                <span class="stat-label">‚úÖ Lessons Completed</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.notes_count|default:0 }}</span>
                <span class="stat-label">üìî Notes Written</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.quizzes_completed|default:0 }}</span>
                <span class="stat-label">üìù Quizzes Taken</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.quiz_accuracy|default:0|floatformat:1 }}%</span>
                <span class="stat-label">üéØ Quiz Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.study_streak|default:0 }}</span>
                <span class="stat-label">üî• Study Streak (days)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.active_days|default:0 }}</span>
                <span class="stat-label">üìÖ Active Days (30d)</span>
            </div>
        </div>
    </div>

    <!-- AI INSIGHTS PANEL -->
    <div class="section">
        <h2 class="section-title">ü§ñ AI-Generated Insights</h2>
        
        <!-- USER PREFERENCES OVERVIEW -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- INTERESTED SUBJECTS -->
            <div style="border: 1px solid #9c27b0; border-left: 4px solid #9c27b0; padding: 20px; border-radius: 6px; background: rgba(156, 39, 176, 0.05);">
                <strong style="color: #ce93d8; display: block; margin-bottom: 12px; font-size: 15px;">üìö Interested Subjects:</strong>
                {% if interested_subjects_list %}
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for subject in interested_subjects_list %}
                        <span style="background: #9c27b0; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                            {{ subject.name }}
                            {% if forloop.first %}<span style="margin-left: 5px;">‚òÖ Primary</span>{% endif %}
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span style="color: #b0b0b0; font-size: 14px;">No subjects selected</span>
                {% endif %}
            </div>
            
            <!-- INTERESTED TAGS -->
            <div style="border: 1px solid #00897b; border-left: 4px solid #00897b; padding: 20px; border-radius: 6px; background: rgba(0, 137, 123, 0.05);">
                <strong style="color: #4db6ac; display: block; margin-bottom: 12px; font-size: 15px;">üè∑Ô∏è Learning Interests:</strong>
                {% if interested_tags_list %}
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for tag in interested_tags_list %}
                        <span style="background: #00897b; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px;">
                            {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span style="color: #b0b0b0; font-size: 14px;">No tags selected</span>
                {% endif %}
            </div>
            
            <!-- RECENT ACTIVITY SUMMARY -->
            <div style="border: 1px solid #ff6f00; border-left: 4px solid #ff6f00; padding: 20px; border-radius: 6px; background: rgba(255, 111, 0, 0.05);">
                <strong style="color: #ffb74d; display: block; margin-bottom: 12px; font-size: 15px;">üìä Recent Activity:</strong>
                {% if user_activity_data %}
                    <div style="font-size: 14px;">
                        <div style="color: #b0b0b0; margin-bottom: 8px;">Last 10 activities:</div>
                        <ul style="margin: 0; padding-left: 20px; color: #e0e0e0;">
                            {% for activity in user_activity_data|slice:":3" %}
                            <li style="margin-bottom: 6px; color: #e0e0e0;">
                                <strong style="color: #ffffff;">{{ activity.activity_type }}</strong>
                                <div style="font-size: 12px; color: #b0b0b0; margin-top: 2px;">{{ activity.created_at|date:"M d, Y H:i" }}</div>
                            </li>
                            {% endfor %}
                            {% if user_activity_data|length > 3 %}
                            <li style="color: #b0b0b0;">+ {{ user_activity_data|length|add:"-3" }} more activities</li>
                            {% endif %}
                        </ul>
                    </div>
                {% else %}
                    <span style="color: #b0b0b0; font-size: 14px;">No recent activity</span>
                {% endif %}
            </div>
        </div>
        
        <div style="padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #6ab7ff; background: rgba(106, 183, 255, 0.03);">
            <h4 style="margin: 0 0 20px 0; color: #6ab7ff; font-size: 16px;">‚ú® Generate New Analysis</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: end;">
                <div>
                    <label for="ai-subject" style="display: block; font-weight: 600; margin-bottom: 10px; color: #e0e0e0; font-size: 14px;">Focus Subject:</label>
                    <select id="ai-subject" name="ai_subject" style="width: 100%; padding: 12px 40px 12px 14px; border: 1px solid #6ab7ff; border-radius: 6px; font-size: 15px; color: #ffffff !important; background-color: #252540 !important;">
                        <option value="">üìö All Subjects</option>
                        {% for subject in interested_subjects_list %}
                        <option value="{{ subject.name }}" {% if subject.name == primary_subject %}selected{% endif %}>{{ subject.name }}</option>
                        {% endfor %}
                        {% if not interested_subjects_list %}
                        <option disabled>No selected subjects</option>
                        {% endif %}
                    </select>
                    <div id="ai-subject-selected" style="margin-top: 8px; font-size: 13px; color: #b0b0b0;">Selected: <span id="ai-subject-selected-text" style="color:#e0e0e0;">üìö All Subjects</span></div>
                </div>
                <div>
                    <label for="ai-engine" style="display: block; font-weight: 600; margin-bottom: 10px; color: #e0e0e0; font-size: 14px;">AI Engine:</label>
                    <select id="ai-engine" name="ai_engine" style="width: 100%; padding: 12px 40px 12px 14px; border: 1px solid #6ab7ff; border-radius: 6px; font-size: 15px; color: #ffffff !important; background-color: #252540 !important;">
                        <optgroup label="Google Gemini">
                            <option value="gemini-2.0-flash-exp" selected>‚ö° Gemini 2.0 Flash (Fast)</option>
                            <option value="gemini-2.0-pro-exp">‚ú® Gemini 2.0 Pro (Best)</option>
                            <option value="gemini-1.5-pro">üîß Gemini 1.5 Pro</option>
                        </optgroup>
                        <optgroup label="OpenAI">
                            <option value="gpt-4o">üöÄ GPT-4o (Best & Latest)</option>
                            <option value="gpt-4o-mini">‚ö° GPT-4o Mini (Fast)</option>
                            <option value="gpt-4-turbo">üîß GPT-4 Turbo (Legacy)</option>
                        </optgroup>
                    </select>
                    <div id="ai-engine-selected" style="margin-top: 8px; font-size: 13px; color: #b0b0b0;">Selected: <span id="ai-engine-selected-text" style="color:#e0e0e0;">‚ö° Gemini 2.0 Flash (Fast)</span></div>
                </div>
                <div>
                    <button type="button" class="refresh-btn" id="generate-insights-btn" onclick="generateAIInsights()" style="width: 100%; margin: 0; padding: 12px 24px; font-size: 15px; white-space: nowrap;">
                        ‚ú® Generate Insights
                    </button>
                </div>
            </div>
            <div class="loading-indicator" id="insights-loading" style="display: none; text-align: center; margin-top: 15px; padding: 10px; background: rgba(106, 183, 255, 0.1); border-radius: 4px;">
                ‚è≥ Analyzing student data with AI...
            </div>
            <div id="insights-result" style="display: none; border: 1px solid #2196f3; padding: 20px; border-radius: 6px; border-left: 4px solid #2196f3; color: #e0e0e0; margin-top: 15px; background: rgba(33, 150, 243, 0.05);"></div>
            <div id="insights-error" style="display: none; border: 1px solid #f44336; padding: 20px; border-radius: 6px; border-left: 4px solid #f44336; color: #ff8a80; margin-top: 15px; background: rgba(244, 67, 54, 0.05);"></div>
        </div>
    </div>

    <!-- OLD AI INSIGHTS (Historical) -->
    {% if old_insights %}
    <div class="section old-insights-section">
        <h2 class="section-title">üïí Previous AI Analyses</h2>
        <p style="color: #b0b0b0; margin-bottom: 20px; font-size: 14px;">
            Historical AI insights from past analyses. Click to expand and view details.
        </p>
        {% for insight in old_insights %}
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion({{ insight.id }})">
                <div>
                    <div class="accordion-title">{{ insight.subject }} ‚Ä¢ {{ insight.engine }}</div>
                    <div class="accordion-meta">
                        Generated: {{ insight.created_at|date:"M d, Y H:i" }} ‚Ä¢ Used {{ insight.hits }} time{{ insight.hits|pluralize }}
                    </div>
                </div>
                <span class="accordion-icon" id="icon-{{ insight.id }}">‚ñº</span>
            </div>
            <div class="accordion-content" id="content-{{ insight.id }}">
                <div id="insight-display-{{ insight.id }}"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- COURSES & LESSONS SECTION -->
    {% if analysis.enrolled_courses %}
    <div class="section">
        <h2 class="section-title">üìö Enrolled Courses & Lessons</h2>
        <ul class="courses-list">
            {% for course in analysis.enrolled_courses %}
            <li class="course-item">
                <div class="course-title">{{ course.title }}</div>
                <div class="course-meta">
                    üìñ {{ course.subject|default:"Unknown Subject" }}
                    {% if course.enrollment_date %}
                    ‚Ä¢ Enrolled: {{ course.enrollment_date|date:"M d, Y" }}
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- AREAS FOR IMPROVEMENT SECTION -->
    {% if analysis.weak_topics %}
    <div class="section">
        <h2 class="section-title">‚ö†Ô∏è Areas for Improvement</h2>
        <p style="color: #b0b0b0; margin-bottom: 15px;">
            Topics with scores below 70% need more practice. Focus here for biggest gains!
        </p>
        <ul class="weak-topics">
            {% for topic in analysis.weak_topics %}
            <li>
                <span class="topic-name">{{ topic.topic }}</span>
                <span class="topic-score">{{ topic.avg_score }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- STRONG AREAS SECTION -->
    {% if analysis.strong_topics %}
    <div class="section">
        <h2 class="section-title">üí™ Strong Areas</h2>
        <p style="color: #b0b0b0; margin-bottom: 15px;">
            Excellent mastery! Scoring 85%+ shows strong understanding of these topics.
        </p>
        <ul class="strong-topics">
            {% for topic in analysis.strong_topics %}
            <li>
                <span class="topic-name">{{ topic.topic }}</span>
                <span class="topic-score">{{ topic.avg_score }}%</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- RECOMMENDATIONS SECTION -->
    <div class="section">
        <h2 class="section-title">üéØ Recommendations</h2>
        
        {% if recommendations.priority_actions %}
        <h3 style="color: #e0e0e0; font-size: 16px; margin: 0 0 15px 0;">üìå Priority Actions</h3>
        <ul class="recommendations-list">
            {% for action in recommendations.priority_actions %}
            <li>{{ action }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if recommendations.study_tips %}
        <h3 style="color: #e0e0e0; font-size: 16px; margin: 20px 0 15px 0;">üí° Study Tips</h3>
        <ul class="recommendations-list">
            {% for tip in recommendations.study_tips %}
            <li>
                <strong>{{ tip.type|title }}:</strong> {{ tip.message }}<br>
                <em style="color: #b0b0b0; font-size: 13px;">üí° {{ tip.suggestion }}</em>
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if recommendations.next_steps %}
        <h3 style="color: #e0e0e0; font-size: 16px; margin: 20px 0 15px 0;">üìã Next Steps</h3>
        <ul class="recommendations-list">
            {% for step in recommendations.next_steps %}
            <li>{{ step }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if not recommendations.priority_actions and not recommendations.study_tips and not recommendations.next_steps %}
        <div class="no-data-message">
            <p>üéâ Great start! Complete more activities to get personalized recommendations.</p>
        </div>
        {% endif %}
    </div>

    <!-- RECENT ACTIVITY SECTION -->
    {% if analysis.recent_activity %}
    <div class="section">
        <h2 class="section-title">üìà Recent Activity</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value">{{ analysis.recent_activity.last_7_days.total_events|default:0 }}</span>
                <span class="stat-label">Events (Last 7 Days)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ analysis.recent_activity.last_30_days.total_events|default:0 }}</span>
                <span class="stat-label">Events (Last 30 Days)</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Helper function to format nested objects/arrays
function formatNestedObject(obj) {
    if (!obj) return '';
    let html = '';
    if (Array.isArray(obj)) {
        html += '<ul style="color: #b0b0b0;">';
        obj.forEach(item => {
            if (typeof item === 'object') {
                html += '<li style="color: #e0e0e0;">' + formatNestedObject(item) + '</li>';
            } else {
                html += '<li style="color: #e0e0e0;">' + item + '</li>';
            }
        });
        html += '</ul>';
    } else if (typeof obj === 'object') {
        html += '<ul style="color: #b0b0b0;">';
        for (let key in obj) {
            if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                if (Array.isArray(value)) {
                    html += '<li style="color: #e0e0e0;"><strong>' + label + ':</strong><ul>';
                    value.forEach(v => {
                        if (typeof v === 'object') {
                            html += '<li style="color: #e0e0e0;">' + formatNestedObject(v) + '</li>';
                        } else {
                            html += '<li style="color: #e0e0e0;">' + v + '</li>';
                        }
                    });
                    html += '</ul></li>';
                } else if (typeof value === 'object') {
                    html += '<li style="color: #e0e0e0;"><strong>' + label + ':</strong> ' + formatNestedObject(value) + '</li>';
                } else {
                    html += '<li style="color: #e0e0e0;"><strong>' + label + ':</strong> ' + value + '</li>';
                }
            }
        }
        html += '</ul>';
    } else {
        html += '<p style="color: #b0b0b0;">' + obj + '</p>';
    }
    return html;
}

// Specialized renderer for grammar analysis to avoid confusing output
function renderGrammarAnalysis(ga) {
    if (!ga) return '';
    let html = '';
    const weak = ga.weak_areas || ga.weakAreas || [];
    const strong = ga.strong_areas || ga.strongAreas || [];
    const insufficient = ga.insufficient_data || ga.insufficientData || false;

    if (insufficient) {
        html += '<p>Insufficient notes for detailed grammar analysis. Please write more notes.</p>';
        return html;
    }

    if (weak.length) {
        html += '<div style="margin-bottom:12px;"><strong>Weak Areas:</strong></div>';
        weak.forEach(area => {
            html += '<div style="margin-bottom:10px; padding:8px; border:1px solid #eee; border-radius:6px;">';
            const type = area.error_type || area.type || 'Grammar Issue';
            const freq = area.frequency || 0;
            html += '<div style="font-weight:600; color:#5e35b1;">' + type + ' <span style="color:#777; font-weight:400;">(frequency: ' + freq + ')</span></div>';
            const examples = area.examples || [];
            if (examples.length) {
                html += '<table style="width:100%; border-collapse:collapse; margin-top:6px;">';
                html += '<thead><tr style="text-align:left; border-bottom:1px solid #ddd;"><th style="padding:6px;">Note ID</th><th style="padding:6px;">Date</th><th style="padding:6px;">Original</th><th style="padding:6px;">Corrected</th><th style="padding:6px;">Rule</th></tr></thead><tbody>';
                examples.forEach(ex => {
                    const noteId = ex.note_id || ex.noteId || '';
                    const date = ex.note_date || ex.noteDate || '';
                    const original = ex.original || '';
                    const corrected = ex.corrected || '';
                    const rule = ex.rule || '';
                    // Flag if original equals corrected to avoid misleading display
                    const same = (original || '').trim() === (corrected || '').trim();
                    const correctedCell = same ? '<span style="color:#999;">(no change)</span>' : corrected;
                    html += '<tr style="border-bottom:1px solid #f0f0f0;">' +
                        '<td style="padding:6px; color:#555;">' + noteId + '</td>' +
                        '<td style="padding:6px; color:#555;">' + date + '</td>' +
                        '<td style="padding:6px;">' + original + '</td>' +
                        '<td style="padding:6px;">' + correctedCell + '</td>' +
                        '<td style="padding:6px; color:#555;">' + (rule || '') + '</td>' +
                        '</tr>';
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
    }

    if (strong.length) {
        html += '<div style="margin-top:12px;"><strong>Strong Areas:</strong>';
        html += formatNestedObject(strong);
        html += '</div>';
    }
    return html;
}

// Store old insights data
const oldInsightsData = {{ old_insights_json|default:"[]" }};

// Accordion toggle function
function toggleAccordion(insightId) {
    const content = document.getElementById('content-' + insightId);
    const icon = document.getElementById('icon-' + insightId);
    const display = document.getElementById('insight-display-' + insightId);
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.classList.remove('expanded');
    } else {
        content.classList.add('show');
        icon.classList.add('expanded');
        
        // Load insight data if not already loaded
        if (!display.innerHTML) {
            // Find insight data from stored array
            const insight = oldInsightsData.find(i => i.id === insightId);
            if (insight && insight.insights) {
                display.innerHTML = renderInsights(insight.insights);
            }
        }
    }
}

function generateAIInsights() {
    console.log('üîò Generate button clicked');
    const btn = document.getElementById('generate-insights-btn');
    const loading = document.getElementById('insights-loading');
    const result = document.getElementById('insights-result');
    const errorDiv = document.getElementById('insights-error');
    const subject = document.getElementById('ai-subject').value;
    const engine = document.getElementById('ai-engine').value;
    
    console.log('üìä Selected subject:', subject);
    console.log('ü§ñ Selected engine:', engine);
    
    // Clear previous results
    result.style.display = 'none';
    errorDiv.style.display = 'none';
    
    // Disable button and show loading
    btn.disabled = true;
    loading.style.display = 'block';
    btn.textContent = '‚è≥ Generating...';
    
    console.log('üöÄ Sending request to:', '{% url "admin:student_ai_insights" user.id %}');
    
    // Make AJAX request to AI insights endpoint
    fetch('{% url "admin:student_ai_insights" user.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            subject: subject,
            engine: engine
        })
    })
    .then(response => {
        console.log('üì° Response received:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üì¶ Data received:', data);
        loading.style.display = 'none';
        btn.disabled = false;
        btn.textContent = '‚ú® Generate Insights';
        
        if (data.success) {
            result.innerHTML = renderInsights(data.insights);
            result.style.display = 'block';
        } else {
            console.error('‚ùå Error in response:', data.error);
            errorDiv.innerHTML = '<strong>‚ö†Ô∏è Error:</strong> ' + (data.error || 'Failed to generate insights');
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('‚ùå Fetch error:', error);
        loading.style.display = 'none';
        errorDiv.innerHTML = '<strong>‚ö†Ô∏è Network Error:</strong> ' + error.message;
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = '‚ú® Generate Insights';
    });
}

// Shared function to render insights
function renderInsights(insights) {
    let html = '<h3 style="color: #6ab7ff; margin-top: 0;">üìä Comprehensive Learning Analysis</h3>';
    
    // EXECUTIVE SUMMARY
    if (insights.summary) {
        html += '<div style="border: 1px solid #2196f3; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2196f3;">';
        html += '<p style="margin: 0; color: #6ab7ff;"><strong>Executive Summary:</strong></p>';
        html += '<p style="margin: 5px 0 0 0; color: #e0e0e0;">' + insights.summary + '</p>';
        html += '</div>';
    }
            
    // ASSESSMENT
    if (insights.assessment) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #e0e0e0; margin: 0 0 10px 0;">üìç Current Learning Level</h4>';
        if (typeof insights.assessment === 'object') {
            html += formatNestedObject(insights.assessment);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.assessment + '</p>';
        }
        html += '</div>';
    }
    
    // VOCABULARY GAPS
    if (insights.vocabulary_gaps) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #ff8a80; margin: 0 0 10px 0;">üìö Vocabulary Gaps</h4>';
        if (typeof insights.vocabulary_gaps === 'object') {
            html += formatNestedObject(insights.vocabulary_gaps);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.vocabulary_gaps + '</p>';
        }
        html += '</div>';
    }
    
    // GRAMMAR ANALYSIS
    if (insights.grammar_analysis) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #ce93d8; margin: 0 0 10px 0;">‚úçÔ∏è Grammar Analysis</h4>';
        if (typeof insights.grammar_analysis === 'object') {
            html += renderGrammarAnalysis(insights.grammar_analysis);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.grammar_analysis + '</p>';
        }
        html += '</div>';
    }
            
    // QUIZ RECOMMENDATIONS
    if (insights.quiz_recommendations && insights.quiz_recommendations.length > 0) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #64b5f6; margin: 0 0 10px 0;">üéØ Recommended Quizzes</h4><ul style="color: #b0b0b0;">';
        insights.quiz_recommendations.forEach(q => {
            html += '<li style="margin-bottom: 8px; color: #e0e0e0;"><strong>' + (q.title || q.topic || q) + '</strong>';
            if (q.reason) html += '<br><span style="color: #b0b0b0; font-size: 13px;">' + q.reason + '</span>';
            if (q.difficulty) html += '<br><span style="border: 1px solid #ffb74d; color: #ffb74d; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Difficulty: ' + q.difficulty + '</span>';
            html += '</li>';
        });
        html += '</ul></div>';
    }
    
    // DIFFICULTY PROGRESSION
    if (insights.difficulty_progression) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #81c784; margin: 0 0 10px 0;">üìà Difficulty Progression</h4>';
        if (typeof insights.difficulty_progression === 'object') {
            html += formatNestedObject(insights.difficulty_progression);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.difficulty_progression + '</p>';
        }
        html += '</div>';
    }
    
    // EXTERNAL RESOURCES
    if (insights.external_resources) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #ef5350; margin: 0 0 10px 0;">üåê External Resources</h4>';
        if (typeof insights.external_resources === 'object') {
            html += formatNestedObject(insights.external_resources);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.external_resources + '</p>';
        }
        html += '</div>';
    }
    
    // STUDY GUIDE
    if (insights.study_guide) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #ffb74d; margin: 0 0 10px 0;">üìã Study Guide</h4>';
        if (typeof insights.study_guide === 'object') {
            html += formatNestedObject(insights.study_guide);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.study_guide + '</p>';
        }
        html += '</div>';
    }
    
    // LEARNING JOURNEY
    if (insights.learning_journey) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #4dd0e1; margin: 0 0 10px 0;">üöÄ Learning Journey</h4>';
        if (typeof insights.learning_journey === 'object') {
            html += formatNestedObject(insights.learning_journey);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.learning_journey + '</p>';
        }
        html += '</div>';
    }

    // EXAM LEVEL PREDICTIONS
    if (insights.exam_level_predictions) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #66bb6a; margin: 0 0 10px 0;">üéì Exam Level Predictions</h4>';
        const e = insights.exam_level_predictions;
        if (typeof e === 'object') {
            html += '<ul style="color: #b0b0b0;">' +
                '<li><strong style="color: #e0e0e0;">CEFR Band:</strong> ' + (e.cefr_band || '-') + '</li>' +
                '<li><strong style="color: #e0e0e0;">TOEIC:</strong> ' + (e.toeic_range || '-') + '</li>' +
                '<li><strong style="color: #e0e0e0;">TOEFL:</strong> ' + (e.toefl_range || '-') + '</li>' +
                '<li><strong style="color: #e0e0e0;">IELTS:</strong> ' + (e.ielts_band || '-') + '</li>' +
                (e.confidence ? '<li><strong style="color: #e0e0e0;">Confidence:</strong> ' + e.confidence + '</li>' : '') +
                (e.reasoning ? '<li><strong style="color: #e0e0e0;">Reasoning:</strong> ' + e.reasoning + '</li>' : '') +
            '</ul>';
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.exam_level_predictions + '</p>';
        }
        html += '</div>';
    }
    
    // SPECIFIC ACTIONS
    if (insights.specific_actions) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #9ccc65; margin: 0 0 10px 0;">‚úÖ Specific Actions</h4>';
        if (typeof insights.specific_actions === 'object') {
            html += formatNestedObject(insights.specific_actions);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.specific_actions + '</p>';
        }
        html += '</div>';
    }
    
    // POTENTIAL STRUGGLES
    if (insights.potential_struggles) {
        html += '<div style="margin-bottom: 20px;"><h4 style="color: #ff7043; margin: 0 0 10px 0;">‚ö†Ô∏è Potential Struggles</h4>';
        if (Array.isArray(insights.potential_struggles)) {
            html += '<ul style="color: #b0b0b0;">';
            insights.potential_struggles.forEach(s => {
                html += '<li style="color: #e0e0e0;">' + s + '</li>';
            });
            html += '</ul>';
        } else if (typeof insights.potential_struggles === 'object') {
            html += formatNestedObject(insights.potential_struggles);
        } else {
            html += '<p style="color: #b0b0b0;">' + insights.potential_struggles + '</p>';
        }
        html += '</div>';
    }
    
    return html;
}

// Fallback labels: keep a visible mirror of selected values
document.addEventListener('DOMContentLoaded', function() {
    const subjectSelect = document.getElementById('ai-subject');
    const engineSelect = document.getElementById('ai-engine');
    const subjectText = document.getElementById('ai-subject-selected-text');
    const engineText = document.getElementById('ai-engine-selected-text');

    function updateSubjectLabel() {
        const opt = subjectSelect.options[subjectSelect.selectedIndex];
        subjectText.textContent = opt ? opt.text : '';
    }
    function updateEngineLabel() {
        const opt = engineSelect.options[engineSelect.selectedIndex];
        engineText.textContent = opt ? opt.text : '';
    }

    // Initial set
    updateSubjectLabel();
    updateEngineLabel();

    // Update on change
    subjectSelect.addEventListener('change', updateSubjectLabel);
    engineSelect.addEventListener('change', updateEngineLabel);
});
</script>
{% endblock %}
